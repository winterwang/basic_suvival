<!DOCTYPE html>
<html>
  <head>
    <title>Survival Analysis</title>
    <meta charset="utf-8">
    <meta name="author" content="Chaochen Wang" />
    <link href="libs/remark-css/default.css" rel="stylesheet" />
    <link href="libs/remark-css/metropolis-fonts.css" rel="stylesheet" />
    <link rel="stylesheet" href="css/LSHTM.css" type="text/css" />
  </head>
  <body>
    <textarea id="source">
class: center, middle, inverse, title-slide

# Survival Analysis
## The basic ideas, models, assumptions, and something beyond
### Chaochen Wang
### 2018/10/03 (updated: 2018-09-26)

---




# Describing survival data (1)

&lt;!-- ### Important assumptions:  --&gt;

&lt;!-- + It is assumed that censoring is uninformative about event times. --&gt;

&lt;!-- + This means that the time at which an individual is censored, or the fact that they are censored, does not give us any information about when that person may have the event. --&gt;

+ We define a random variable `\(T\)`, which represents survival time.

+ The survival function 

    + The survivor function at a time `\(t\)` is the probability that the survival time `\(T\)` exceeds a value `\(t\)`:

`$$S(t) = \text{Pr}(T&gt;t)$$`
  + Relation to the cumulative distribution function: 
    
$$
`\begin{aligned}
F(t) &amp; =  \text{Pr}(T\leqslant t) \\
     &amp; = 1 - \text{Pr}(T&gt;t) \\ 
     &amp; = 1- S(t)
\end{aligned}`
$$

+ The hazard function

$$
h(t) = \text{lim}_{\delta\rightarrow0}\frac{1}{\delta}\text{Pr}(t\leqslant T &lt; t + \delta | T \geqslant t)
$$


---
class: middle

# Describing survival data (2)

- The cumulative hazard function

$$
H(t) = \int_o^th(u)du
$$


- The probability density function at time `\(t\)`:

$$
f(t) = \frac{d}{dt}F(t) = \text{lim}_{\delta\rightarrow0}\frac{1}{\delta}\text{Pr}(t\leqslant T &lt; t + \delta)
$$
- In general, and in particular to incorporate continuous variables and adjustment for confounders, we want to use
**regression-based approaches** to analyze survival data. 

- Methods of analysis need to **handle censoring** and need to allow for the fact that **survival times are strictly non-negative**.


---
class: middle

### Relationships between functions (1)

&lt;!-- ## `\(S(t), h(t), H(t), f(t)\)` --&gt;

$$
`\begin{aligned}
f(t) &amp; = \frac{\text{d}}{\text{d}t}F(t)  = \frac{\text{d}}{\text{d}t}\{ 1-S(t) \} = - \frac{\text{d}}{\text{d}t}S(t) \\
S(t) &amp; = 1 - F(t)  = 1 - \int_0^t f(u)\text{d}u = \int_t^\infty f(u)\text{d}u \\
h(t) &amp; = \lim_{\delta\rightarrow0}\frac{1}{\delta}\text{Pr}(t \leqslant T &lt; t+ \delta | T &gt; t) \\
     &amp; = \lim_{\delta\rightarrow0}\frac{1}{\delta}\frac{\text{Pr}(t \leqslant T &lt; t+ \delta, T &gt; t)}{\text{Pr}(T &gt; t)} (\text{Bayes' Theroem}) \\
     &amp; = \lim_{\delta\rightarrow0}\frac{1}{\delta}\frac{\text{Pr}(t \leqslant T &lt; t+ \delta)}{\text{Pr}(T &gt; t)} = \frac{f(t)}{S(t)}\\
h(t) &amp; = \frac{f(t)}{S(t)} = \frac{\frac{\text{d}}{\text{d}t}F(t)}{S(t)}  \\
     &amp; = \frac{- \frac{\text{d}}{\text{d}t}S(t)}{S(t)} = -\frac{d\log[S(t)]}{dS(t)}\cdot\frac{dS(t)}{dt}  \\ 
     &amp; = - \frac{\text{d}}{\text{d}t}\text{log}[S(t)] (\text{chain rule}) \\
\end{aligned}`
$$


---
class: middle

### Relationships between functions (2)

$$
`\begin{aligned}
H(t) &amp;  = \int_0^th(u)du = \int_0^t\frac{f(u)}{S(u)}du = \int_0^t\frac{f(u)}{1-F(u)}du  \\
     &amp; = - \int_0^t\frac{-f(u)}{1-F(u)}du = - \log[1-F(t)] = -\log[S(t)] \\ 
\Rightarrow S(t) &amp; = \exp[-H(t)]
\end{aligned}`
$$


---
class: middle
# Analysing survival data

### 1. Fully parametric methods
- Exponential distribution
- Weibull distribution
- Log-logistic distribution

### 2. Non-parametric methods 
- Kaplan-Meier estimate of the survivor function
- Life table estimates
- Log rank test
- Nelson-Aalen estimate of the cumulative hazard

### 3. Semi-parametric methods
- Cox proportional hazards model

---
class: middle
# Parametric models (1)

**Exponential distribution:** Under the exponential distribution the hazard rate is constant over time: `\(\lambda\)`

$$
`\begin{aligned}
h(t) &amp; = \lambda \\
S(t) &amp; = \exp(-\lambda t) \\
f(t) &amp; = \lambda\exp(-\lambda t) \\
\end{aligned}`
$$
*Proportional hazard model:*
`$$h(t|x) = h_0(t)\exp(\beta x) = \lambda \exp(\beta x)$$`

**Weibull Distribution:**

$$
`\begin{aligned}
h(t) &amp; = \lambda\kappa t^{\kappa - 1} \\ 
S(t) &amp; = \exp(-\lambda t^\kappa) \\ 
f(t) &amp; = \lambda\kappa t^{\kappa - 1}\exp(-\lambda t^\kappa)
\end{aligned}`
$$

*Proportional hazard model:*

`$$h(t|x) = h_0(t)\exp(\beta x) = \lambda\kappa t^{\kappa - 1} \exp(\beta x)$$`

---
class: middle
# Parametric models (2)


- The assumption that `\(\beta\)` does not depend on `\(t\)` is called the **proportional hazards assumption** -- the effect on the hazard does not change over time.

- The ratio of the hazards in the two groups is called: **Hazard ratio**
$$
\frac{h(t|x)}{h_0(t)} = \exp(\beta)
$$

- `\(\beta\)` is called log hazard ratio

- The hazard ratio `\(\exp(\beta)\)` does not depend on time (the **proportional hazards assumption**) -- it is **constant** over time .


---
class: middle
# Semi-parametric model (1)

Form of a proportional hazard model:

$$
h(t|x) = h_0(t)\exp(\beta x)
$$

In fully parametric survival models (exponential distribution model, Weibull distribution model, etc.), a form is assumed for `\(h_0(t)\)` (baseline hazard).

We have to specify a form for the baseline hazard in fully parametric survival models, which we may make mistakes.

But, 

--

- If the hazard ratio `\(\exp(\beta)\)` is the only parameter of interest. 

--
- **Do we really care about the baseline hazard** `\(h_0(t)\)` ?


---
class: inverse
background-image: url("./img/Idontcare.jpg")
background-position: 50% 50%
background-size: contain


---
class: middle
# Semi-parametric model (2)

- Cox (1972) &lt;sup&gt;1&lt;/sup&gt; suggested that the baseline hazard could be left un-specified.

- The model for the hazard of the form is called **Cox proportional hazards model** if no form is given for the baseline hazard. 

$$
h(t|x) = h_0(t)\exp(\beta x) 
$$

- This is a **semi-parametric model** because the effect (hazard ratio) of explanatory variable `\(x\)` on the hazard is parameterized, but `\(h_0(t)\)` (baseline hazard) is not parameterized. 


.footnote[
[1] Cox, David R. 1972. “Models and Life-Tables Regression.” JR Stat. Soc. Ser. B 34: 187–220.]


---
class: inverse, middle, center
# What are we assuming?

---
class: middle
# Assumptions

1. **The proportional hazards assumption** that the explanatory variables act on survival in such a way that the hazard ratio is constant over time: `\(h(t|x) = h_0(t)\exp(\beta x)\)` is correct.

2. The assumption that we have **correctly specified the form** for how the explanatory variables act on the hazard: `\(h(t|x) = h_0(t)\exp(\beta x) \text{ versus } h(t|x) = h_0(t)\exp(\beta_1 x + \beta_2 x^2)\)`.

3. Censoring is **uninformative** for the event of interest.

4. Individuals are **independent**.

5. We have included **all relevant** explanatory variables **including possible interactions**.


---
class: middle
### Assessing the proportional hazards assumption (plot)

- The survivor function: 

$$
S(t|x) = \exp[-H_0(t)e^{\beta x}]
$$

- Take logs and moving the minus sign: 
$$
-\log S(t|x) = -H_0(t)e^{\beta x}
$$

- Take logs again: 
$$
\log[-\log S(t|x)] = \log H_0(t) + \beta x
$$


- If `\(x\)` is a binary (0 or 1) variable, then if we plot `\(\log[-\log S(t|0)]\)` and `\(\log[-\log S(t|1)]\)` against **time (or other function of time, such as log time)**, the curves for different groups should be approximately **parallel over time** if the proportional hazards assumption is met. 


---
class: middle
### Assessing the proportional hazards assumption (plot)

- In Stata, this can be easily done by the following command after `stset` survival data:

```
stphplot, by(treat)
```

- In R, a little bit working


```r
survfit_object &lt;- survfit(Surv(time, event) ~ treat, data)
plot(survfit_object, fun = "cloglog", xlab = "time(logcale)", 
   ylab = "log(-logS(t))")
```
    </textarea>
<script src="https://remarkjs.com/downloads/remark-latest.min.js"></script>
<script>var slideshow = remark.create({
"highlightStyle": "github",
"highlightLines": true,
"countIncrementalSlides": false
});
if (window.HTMLWidgets) slideshow.on('afterShowSlide', function (slide) {
  window.dispatchEvent(new Event('resize'));
});
(function() {
  var d = document, s = d.createElement("style"), r = d.querySelector(".remark-slide-scaler");
  if (!r) return;
  s.type = "text/css"; s.innerHTML = "@page {size: " + r.style.width + " " + r.style.height +"; }";
  d.head.appendChild(s);
})();
(function(time) {
  var d2 = function(number) {
    return ('0' + number).slice(-2); // left-pad 0 to minutes/seconds
  },

  time_format = function(total) {
    var secs = Math.abs(total) / 1000;
    var h = Math.floor(secs / 3600);
    var m = Math.floor(secs % 3600 / 60);
    var s = Math.round(secs % 60);
    var res = d2(m) + ':' + d2(s);
    if (h > 0) res = h + ':' + res;
    return res;  // [hh:]mm:ss
  },

  slide_number_div = function(i) {
    return document.getElementsByClassName('remark-slide-number').item(i);
  },

  current_page_number = function(i) {
    return slide_number_div(i).firstChild.textContent;  // text "i / N"
  };

  var timer = document.createElement('span'); timer.id = 'slide-time-left';
  var time_left = time, k = slideshow.getCurrentSlideIndex(),
      last_page_number = current_page_number(k);

  setInterval(function() {
    time_left = time_left - 1000;
    timer.innerHTML = ' ' + time_format(time_left);
    if (time_left < 0) timer.style.color = 'red';
  }, 1000);

  slide_number_div(k).appendChild(timer);

  slideshow.on('showSlide', function(slide) {
    var i = slide.getSlideIndex(), n = current_page_number(i);
    // reset timer when a new slide is shown and the page number is changed
    if (last_page_number !== n) {
      time_left = time; last_page_number = n;
      timer.innerHTML = ' ' + time_format(time); timer.style.color = null;
    }
    slide_number_div(i).appendChild(timer);
  });
})(60000);</script>

<script>
(function() {
  var i, text, code, codes = document.getElementsByTagName('code');
  for (i = 0; i < codes.length;) {
    code = codes[i];
    if (code.parentNode.tagName !== 'PRE' && code.childElementCount === 0) {
      text = code.textContent;
      if (/^\\\((.|\s)+\\\)$/.test(text) || /^\\\[(.|\s)+\\\]$/.test(text) ||
          /^\$\$(.|\s)+\$\$$/.test(text) ||
          /^\\begin\{([^}]+)\}(.|\s)+\\end\{[^}]+\}$/.test(text)) {
        code.outerHTML = code.innerHTML;  // remove <code></code>
        continue;
      }
    }
    i++;
  }
})();
</script>
<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
(function () {
  var script = document.createElement('script');
  script.type = 'text/javascript';
  script.src  = 'https://cdn.bootcss.com/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_CHTML';
  if (location.protocol !== 'file:' && /^https?:/.test(script.src))
    script.src  = script.src.replace(/^https?:/, '');
  document.getElementsByTagName('head')[0].appendChild(script);
})();
</script>
  </body>
</html>
